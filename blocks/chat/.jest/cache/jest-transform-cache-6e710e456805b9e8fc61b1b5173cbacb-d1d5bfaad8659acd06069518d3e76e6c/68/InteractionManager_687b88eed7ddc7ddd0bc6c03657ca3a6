63a9ffe88a66e619ab843902bfe64fc0
'use strict';

var BatchedBridge = require('../BatchedBridge/BatchedBridge');
var EventEmitter = require('../vendor/emitter/EventEmitter');
var TaskQueue = require('./TaskQueue');
var infoLog = require('../Utilities/infoLog');
var invariant = require('invariant');
var keyMirror = require('fbjs/lib/keyMirror');
var _emitter = new EventEmitter();
var DEBUG_DELAY = 0;
var DEBUG = false;
var InteractionManager = {
  Events: keyMirror({
    interactionStart: true,
    interactionComplete: true
  }),
  runAfterInteractions: function runAfterInteractions(task) {
    var tasks = [];
    var promise = new Promise(function (resolve) {
      _scheduleUpdate();
      if (task) {
        tasks.push(task);
      }
      tasks.push({
        run: resolve,
        name: 'resolve ' + (task && task.name || '?')
      });
      _taskQueue.enqueueTasks(tasks);
    });
    return {
      then: promise.then.bind(promise),
      done: function done() {
        if (promise.done) {
          return promise.done.apply(promise, arguments);
        } else {
          console.warn('Tried to call done when not supported by current Promise implementation.');
        }
      },
      cancel: function cancel() {
        _taskQueue.cancelTasks(tasks);
      }
    };
  },
  createInteractionHandle: function createInteractionHandle() {
    DEBUG && infoLog('InteractionManager: create interaction handle');
    _scheduleUpdate();
    var handle = ++_inc;
    _addInteractionSet.add(handle);
    return handle;
  },
  clearInteractionHandle: function clearInteractionHandle(handle) {
    DEBUG && infoLog('InteractionManager: clear interaction handle');
    invariant(!!handle, 'InteractionManager: Must provide a handle to clear.');
    _scheduleUpdate();
    _addInteractionSet.delete(handle);
    _deleteInteractionSet.add(handle);
  },
  addListener: _emitter.addListener.bind(_emitter),
  setDeadline: function setDeadline(deadline) {
    _deadline = deadline;
  }
};
var _interactionSet = new Set();
var _addInteractionSet = new Set();
var _deleteInteractionSet = new Set();
var _taskQueue = new TaskQueue({
  onMoreTasks: _scheduleUpdate
});
var _nextUpdateHandle = 0;
var _inc = 0;
var _deadline = -1;
function _scheduleUpdate() {
  if (!_nextUpdateHandle) {
    if (_deadline > 0) {
      _nextUpdateHandle = setTimeout(_processUpdate, 0 + DEBUG_DELAY);
    } else {
      _nextUpdateHandle = setImmediate(_processUpdate);
    }
  }
}
function _processUpdate() {
  _nextUpdateHandle = 0;
  var interactionCount = _interactionSet.size;
  _addInteractionSet.forEach(function (handle) {
    return _interactionSet.add(handle);
  });
  _deleteInteractionSet.forEach(function (handle) {
    return _interactionSet.delete(handle);
  });
  var nextInteractionCount = _interactionSet.size;
  if (interactionCount !== 0 && nextInteractionCount === 0) {
    _emitter.emit(InteractionManager.Events.interactionComplete);
  } else if (interactionCount === 0 && nextInteractionCount !== 0) {
    _emitter.emit(InteractionManager.Events.interactionStart);
  }
  if (nextInteractionCount === 0) {
    while (_taskQueue.hasTasksToProcess()) {
      _taskQueue.processNext();
      if (_deadline > 0 && BatchedBridge.getEventLoopRunningTime() >= _deadline) {
        _scheduleUpdate();
        break;
      }
    }
  }
  _addInteractionSet.clear();
  _deleteInteractionSet.clear();
}
module.exports = InteractionManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCYXRjaGVkQnJpZGdlIiwicmVxdWlyZSIsIkV2ZW50RW1pdHRlciIsIlRhc2tRdWV1ZSIsImluZm9Mb2ciLCJpbnZhcmlhbnQiLCJrZXlNaXJyb3IiLCJfZW1pdHRlciIsIkRFQlVHX0RFTEFZIiwiREVCVUciLCJJbnRlcmFjdGlvbk1hbmFnZXIiLCJFdmVudHMiLCJpbnRlcmFjdGlvblN0YXJ0IiwiaW50ZXJhY3Rpb25Db21wbGV0ZSIsInJ1bkFmdGVySW50ZXJhY3Rpb25zIiwidGFzayIsInRhc2tzIiwicHJvbWlzZSIsIlByb21pc2UiLCJyZXNvbHZlIiwiX3NjaGVkdWxlVXBkYXRlIiwicHVzaCIsInJ1biIsIm5hbWUiLCJfdGFza1F1ZXVlIiwiZW5xdWV1ZVRhc2tzIiwidGhlbiIsImJpbmQiLCJkb25lIiwiYXBwbHkiLCJhcmd1bWVudHMiLCJjb25zb2xlIiwid2FybiIsImNhbmNlbCIsImNhbmNlbFRhc2tzIiwiY3JlYXRlSW50ZXJhY3Rpb25IYW5kbGUiLCJoYW5kbGUiLCJfaW5jIiwiX2FkZEludGVyYWN0aW9uU2V0IiwiYWRkIiwiY2xlYXJJbnRlcmFjdGlvbkhhbmRsZSIsImRlbGV0ZSIsIl9kZWxldGVJbnRlcmFjdGlvblNldCIsImFkZExpc3RlbmVyIiwic2V0RGVhZGxpbmUiLCJkZWFkbGluZSIsIl9kZWFkbGluZSIsIl9pbnRlcmFjdGlvblNldCIsIlNldCIsIm9uTW9yZVRhc2tzIiwiX25leHRVcGRhdGVIYW5kbGUiLCJzZXRUaW1lb3V0IiwiX3Byb2Nlc3NVcGRhdGUiLCJzZXRJbW1lZGlhdGUiLCJpbnRlcmFjdGlvbkNvdW50Iiwic2l6ZSIsImZvckVhY2giLCJuZXh0SW50ZXJhY3Rpb25Db3VudCIsImVtaXQiLCJoYXNUYXNrc1RvUHJvY2VzcyIsInByb2Nlc3NOZXh0IiwiZ2V0RXZlbnRMb29wUnVubmluZ1RpbWUiLCJjbGVhciIsIm1vZHVsZSIsImV4cG9ydHMiXSwic291cmNlcyI6WyJJbnRlcmFjdGlvbk1hbmFnZXIuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGVcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqXG4gKiBAZm9ybWF0XG4gKiBAZmxvd1xuICovXG5cbid1c2Ugc3RyaWN0JztcblxuY29uc3QgQmF0Y2hlZEJyaWRnZSA9IHJlcXVpcmUoJy4uL0JhdGNoZWRCcmlkZ2UvQmF0Y2hlZEJyaWRnZScpO1xuY29uc3QgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnLi4vdmVuZG9yL2VtaXR0ZXIvRXZlbnRFbWl0dGVyJyk7XG5jb25zdCBUYXNrUXVldWUgPSByZXF1aXJlKCcuL1Rhc2tRdWV1ZScpO1xuXG5jb25zdCBpbmZvTG9nID0gcmVxdWlyZSgnLi4vVXRpbGl0aWVzL2luZm9Mb2cnKTtcbmNvbnN0IGludmFyaWFudCA9IHJlcXVpcmUoJ2ludmFyaWFudCcpO1xuY29uc3Qga2V5TWlycm9yID0gcmVxdWlyZSgnZmJqcy9saWIva2V5TWlycm9yJyk7XG5cbmV4cG9ydCB0eXBlIEhhbmRsZSA9IG51bWJlcjtcbmltcG9ydCB0eXBlIHtUYXNrfSBmcm9tICcuL1Rhc2tRdWV1ZSc7XG5cbmNvbnN0IF9lbWl0dGVyID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG5jb25zdCBERUJVR19ERUxBWTogMCA9IDA7XG5jb25zdCBERUJVRzogZmFsc2UgPSBmYWxzZTtcblxuLyoqXG4gKiBJbnRlcmFjdGlvbk1hbmFnZXIgYWxsb3dzIGxvbmctcnVubmluZyB3b3JrIHRvIGJlIHNjaGVkdWxlZCBhZnRlciBhbnlcbiAqIGludGVyYWN0aW9ucy9hbmltYXRpb25zIGhhdmUgY29tcGxldGVkLiBJbiBwYXJ0aWN1bGFyLCB0aGlzIGFsbG93cyBKYXZhU2NyaXB0XG4gKiBhbmltYXRpb25zIHRvIHJ1biBzbW9vdGhseS5cbiAqXG4gKiBBcHBsaWNhdGlvbnMgY2FuIHNjaGVkdWxlIHRhc2tzIHRvIHJ1biBhZnRlciBpbnRlcmFjdGlvbnMgd2l0aCB0aGUgZm9sbG93aW5nOlxuICpcbiAqIGBgYFxuICogSW50ZXJhY3Rpb25NYW5hZ2VyLnJ1bkFmdGVySW50ZXJhY3Rpb25zKCgpID0+IHtcbiAqICAgLy8gLi4ubG9uZy1ydW5uaW5nIHN5bmNocm9ub3VzIHRhc2suLi5cbiAqIH0pO1xuICogYGBgXG4gKlxuICogQ29tcGFyZSB0aGlzIHRvIG90aGVyIHNjaGVkdWxpbmcgYWx0ZXJuYXRpdmVzOlxuICpcbiAqIC0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCk6IGZvciBjb2RlIHRoYXQgYW5pbWF0ZXMgYSB2aWV3IG92ZXIgdGltZS5cbiAqIC0gc2V0SW1tZWRpYXRlL3NldFRpbWVvdXQoKTogcnVuIGNvZGUgbGF0ZXIsIG5vdGUgdGhpcyBtYXkgZGVsYXkgYW5pbWF0aW9ucy5cbiAqIC0gcnVuQWZ0ZXJJbnRlcmFjdGlvbnMoKTogcnVuIGNvZGUgbGF0ZXIsIHdpdGhvdXQgZGVsYXlpbmcgYWN0aXZlIGFuaW1hdGlvbnMuXG4gKlxuICogVGhlIHRvdWNoIGhhbmRsaW5nIHN5c3RlbSBjb25zaWRlcnMgb25lIG9yIG1vcmUgYWN0aXZlIHRvdWNoZXMgdG8gYmUgYW5cbiAqICdpbnRlcmFjdGlvbicgYW5kIHdpbGwgZGVsYXkgYHJ1bkFmdGVySW50ZXJhY3Rpb25zKClgIGNhbGxiYWNrcyB1bnRpbCBhbGxcbiAqIHRvdWNoZXMgaGF2ZSBlbmRlZCBvciBiZWVuIGNhbmNlbGxlZC5cbiAqXG4gKiBJbnRlcmFjdGlvbk1hbmFnZXIgYWxzbyBhbGxvd3MgYXBwbGljYXRpb25zIHRvIHJlZ2lzdGVyIGFuaW1hdGlvbnMgYnlcbiAqIGNyZWF0aW5nIGFuIGludGVyYWN0aW9uICdoYW5kbGUnIG9uIGFuaW1hdGlvbiBzdGFydCwgYW5kIGNsZWFyaW5nIGl0IHVwb25cbiAqIGNvbXBsZXRpb246XG4gKlxuICogYGBgXG4gKiB2YXIgaGFuZGxlID0gSW50ZXJhY3Rpb25NYW5hZ2VyLmNyZWF0ZUludGVyYWN0aW9uSGFuZGxlKCk7XG4gKiAvLyBydW4gYW5pbWF0aW9uLi4uIChgcnVuQWZ0ZXJJbnRlcmFjdGlvbnNgIHRhc2tzIGFyZSBxdWV1ZWQpXG4gKiAvLyBsYXRlciwgb24gYW5pbWF0aW9uIGNvbXBsZXRpb246XG4gKiBJbnRlcmFjdGlvbk1hbmFnZXIuY2xlYXJJbnRlcmFjdGlvbkhhbmRsZShoYW5kbGUpO1xuICogLy8gcXVldWVkIHRhc2tzIHJ1biBpZiBhbGwgaGFuZGxlcyB3ZXJlIGNsZWFyZWRcbiAqIGBgYFxuICpcbiAqIGBydW5BZnRlckludGVyYWN0aW9uc2AgdGFrZXMgZWl0aGVyIGEgcGxhaW4gY2FsbGJhY2sgZnVuY3Rpb24sIG9yIGFcbiAqIGBQcm9taXNlVGFza2Agb2JqZWN0IHdpdGggYSBgZ2VuYCBtZXRob2QgdGhhdCByZXR1cm5zIGEgYFByb21pc2VgLiAgSWYgYVxuICogYFByb21pc2VUYXNrYCBpcyBzdXBwbGllZCwgdGhlbiBpdCBpcyBmdWxseSByZXNvbHZlZCAoaW5jbHVkaW5nIGFzeW5jaHJvbm91c1xuICogZGVwZW5kZW5jaWVzIHRoYXQgYWxzbyBzY2hlZHVsZSBtb3JlIHRhc2tzIHZpYSBgcnVuQWZ0ZXJJbnRlcmFjdGlvbnNgKSBiZWZvcmVcbiAqIHN0YXJ0aW5nIG9uIHRoZSBuZXh0IHRhc2sgdGhhdCBtaWdodCBoYXZlIGJlZW4gcXVldWVkIHVwIHN5bmNocm9ub3VzbHlcbiAqIGVhcmxpZXIuXG4gKlxuICogQnkgZGVmYXVsdCwgcXVldWVkIHRhc2tzIGFyZSBleGVjdXRlZCB0b2dldGhlciBpbiBhIGxvb3AgaW4gb25lXG4gKiBgc2V0SW1tZWRpYXRlYCBiYXRjaC4gSWYgYHNldERlYWRsaW5lYCBpcyBjYWxsZWQgd2l0aCBhIHBvc2l0aXZlIG51bWJlciwgdGhlblxuICogdGFza3Mgd2lsbCBvbmx5IGJlIGV4ZWN1dGVkIHVudGlsIHRoZSBkZWFkbGluZSAoaW4gdGVybXMgb2YganMgZXZlbnQgbG9vcCBydW5cbiAqIHRpbWUpIGFwcHJvYWNoZXMsIGF0IHdoaWNoIHBvaW50IGV4ZWN1dGlvbiB3aWxsIHlpZWxkIHZpYSBzZXRUaW1lb3V0LFxuICogYWxsb3dpbmcgZXZlbnRzIHN1Y2ggYXMgdG91Y2hlcyB0byBzdGFydCBpbnRlcmFjdGlvbnMgYW5kIGJsb2NrIHF1ZXVlZCB0YXNrc1xuICogZnJvbSBleGVjdXRpbmcsIG1ha2luZyBhcHBzIG1vcmUgcmVzcG9uc2l2ZS5cbiAqL1xuY29uc3QgSW50ZXJhY3Rpb25NYW5hZ2VyID0ge1xuICBFdmVudHM6IGtleU1pcnJvcih7XG4gICAgaW50ZXJhY3Rpb25TdGFydDogdHJ1ZSxcbiAgICBpbnRlcmFjdGlvbkNvbXBsZXRlOiB0cnVlLFxuICB9KSxcblxuICAvKipcbiAgICogU2NoZWR1bGUgYSBmdW5jdGlvbiB0byBydW4gYWZ0ZXIgYWxsIGludGVyYWN0aW9ucyBoYXZlIGNvbXBsZXRlZC4gUmV0dXJucyBhIGNhbmNlbGxhYmxlXG4gICAqIFwicHJvbWlzZVwiLlxuICAgKi9cbiAgcnVuQWZ0ZXJJbnRlcmFjdGlvbnMoXG4gICAgdGFzazogP1Rhc2ssXG4gICk6IHt0aGVuOiBGdW5jdGlvbiwgZG9uZTogRnVuY3Rpb24sIGNhbmNlbDogRnVuY3Rpb259IHtcbiAgICBjb25zdCB0YXNrcyA9IFtdO1xuICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgIF9zY2hlZHVsZVVwZGF0ZSgpO1xuICAgICAgaWYgKHRhc2spIHtcbiAgICAgICAgdGFza3MucHVzaCh0YXNrKTtcbiAgICAgIH1cbiAgICAgIHRhc2tzLnB1c2goe1xuICAgICAgICBydW46IHJlc29sdmUsXG4gICAgICAgIG5hbWU6ICdyZXNvbHZlICcgKyAoKHRhc2sgJiYgdGFzay5uYW1lKSB8fCAnPycpLFxuICAgICAgfSk7XG4gICAgICBfdGFza1F1ZXVlLmVucXVldWVUYXNrcyh0YXNrcyk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHtcbiAgICAgIHRoZW46IHByb21pc2UudGhlbi5iaW5kKHByb21pc2UpLFxuICAgICAgZG9uZTogKC4uLmFyZ3MpID0+IHtcbiAgICAgICAgaWYgKHByb21pc2UuZG9uZSkge1xuICAgICAgICAgIHJldHVybiBwcm9taXNlLmRvbmUoLi4uYXJncyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc29sZS53YXJuKFxuICAgICAgICAgICAgJ1RyaWVkIHRvIGNhbGwgZG9uZSB3aGVuIG5vdCBzdXBwb3J0ZWQgYnkgY3VycmVudCBQcm9taXNlIGltcGxlbWVudGF0aW9uLicsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIGNhbmNlbDogZnVuY3Rpb24oKSB7XG4gICAgICAgIF90YXNrUXVldWUuY2FuY2VsVGFza3ModGFza3MpO1xuICAgICAgfSxcbiAgICB9O1xuICB9LFxuXG4gIC8qKlxuICAgKiBOb3RpZnkgbWFuYWdlciB0aGF0IGFuIGludGVyYWN0aW9uIGhhcyBzdGFydGVkLlxuICAgKi9cbiAgY3JlYXRlSW50ZXJhY3Rpb25IYW5kbGUoKTogSGFuZGxlIHtcbiAgICBERUJVRyAmJiBpbmZvTG9nKCdJbnRlcmFjdGlvbk1hbmFnZXI6IGNyZWF0ZSBpbnRlcmFjdGlvbiBoYW5kbGUnKTtcbiAgICBfc2NoZWR1bGVVcGRhdGUoKTtcbiAgICBjb25zdCBoYW5kbGUgPSArK19pbmM7XG4gICAgX2FkZEludGVyYWN0aW9uU2V0LmFkZChoYW5kbGUpO1xuICAgIHJldHVybiBoYW5kbGU7XG4gIH0sXG5cbiAgLyoqXG4gICAqIE5vdGlmeSBtYW5hZ2VyIHRoYXQgYW4gaW50ZXJhY3Rpb24gaGFzIGNvbXBsZXRlZC5cbiAgICovXG4gIGNsZWFySW50ZXJhY3Rpb25IYW5kbGUoaGFuZGxlOiBIYW5kbGUpIHtcbiAgICBERUJVRyAmJiBpbmZvTG9nKCdJbnRlcmFjdGlvbk1hbmFnZXI6IGNsZWFyIGludGVyYWN0aW9uIGhhbmRsZScpO1xuICAgIGludmFyaWFudCghIWhhbmRsZSwgJ0ludGVyYWN0aW9uTWFuYWdlcjogTXVzdCBwcm92aWRlIGEgaGFuZGxlIHRvIGNsZWFyLicpO1xuICAgIF9zY2hlZHVsZVVwZGF0ZSgpO1xuICAgIF9hZGRJbnRlcmFjdGlvblNldC5kZWxldGUoaGFuZGxlKTtcbiAgICBfZGVsZXRlSW50ZXJhY3Rpb25TZXQuYWRkKGhhbmRsZSk7XG4gIH0sXG5cbiAgYWRkTGlzdGVuZXI6IChfZW1pdHRlci5hZGRMaXN0ZW5lci5iaW5kKF9lbWl0dGVyKTogJEZsb3dGaXhNZSksXG5cbiAgLyoqXG4gICAqIEEgcG9zaXRpdmUgbnVtYmVyIHdpbGwgdXNlIHNldFRpbWVvdXQgdG8gc2NoZWR1bGUgYW55IHRhc2tzIGFmdGVyIHRoZVxuICAgKiBldmVudExvb3BSdW5uaW5nVGltZSBoaXRzIHRoZSBkZWFkbGluZSB2YWx1ZSwgb3RoZXJ3aXNlIGFsbCB0YXNrcyB3aWxsIGJlXG4gICAqIGV4ZWN1dGVkIGluIG9uZSBzZXRJbW1lZGlhdGUgYmF0Y2ggKGRlZmF1bHQpLlxuICAgKi9cbiAgc2V0RGVhZGxpbmUoZGVhZGxpbmU6IG51bWJlcikge1xuICAgIF9kZWFkbGluZSA9IGRlYWRsaW5lO1xuICB9LFxufTtcblxuY29uc3QgX2ludGVyYWN0aW9uU2V0ID0gbmV3IFNldCgpO1xuY29uc3QgX2FkZEludGVyYWN0aW9uU2V0ID0gbmV3IFNldCgpO1xuY29uc3QgX2RlbGV0ZUludGVyYWN0aW9uU2V0ID0gbmV3IFNldCgpO1xuY29uc3QgX3Rhc2tRdWV1ZSA9IG5ldyBUYXNrUXVldWUoe29uTW9yZVRhc2tzOiBfc2NoZWR1bGVVcGRhdGV9KTtcbmxldCBfbmV4dFVwZGF0ZUhhbmRsZSA9IDA7XG5sZXQgX2luYyA9IDA7XG5sZXQgX2RlYWRsaW5lID0gLTE7XG5cbmRlY2xhcmUgZnVuY3Rpb24gc2V0SW1tZWRpYXRlKGNhbGxiYWNrOiBhbnksIC4uLmFyZ3M6IEFycmF5PGFueT4pOiBudW1iZXI7XG5cbi8qKlxuICogU2NoZWR1bGUgYW4gYXN5bmNocm9ub3VzIHVwZGF0ZSB0byB0aGUgaW50ZXJhY3Rpb24gc3RhdGUuXG4gKi9cbmZ1bmN0aW9uIF9zY2hlZHVsZVVwZGF0ZSgpIHtcbiAgaWYgKCFfbmV4dFVwZGF0ZUhhbmRsZSkge1xuICAgIGlmIChfZGVhZGxpbmUgPiAwKSB7XG4gICAgICAvKiAkRmxvd0ZpeE1lKD49MC42My4wIHNpdGU9cmVhY3RfbmF0aXZlX2ZiKSBUaGlzIGNvbW1lbnQgc3VwcHJlc3NlcyBhblxuICAgICAgICogZXJyb3IgZm91bmQgd2hlbiBGbG93IHYwLjYzIHdhcyBkZXBsb3llZC4gVG8gc2VlIHRoZSBlcnJvciBkZWxldGUgdGhpc1xuICAgICAgICogY29tbWVudCBhbmQgcnVuIEZsb3cuICovXG4gICAgICBfbmV4dFVwZGF0ZUhhbmRsZSA9IHNldFRpbWVvdXQoX3Byb2Nlc3NVcGRhdGUsIDAgKyBERUJVR19ERUxBWSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIF9uZXh0VXBkYXRlSGFuZGxlID0gc2V0SW1tZWRpYXRlKF9wcm9jZXNzVXBkYXRlKTtcbiAgICB9XG4gIH1cbn1cblxuLyoqXG4gKiBOb3RpZnkgbGlzdGVuZXJzLCBwcm9jZXNzIHF1ZXVlLCBldGNcbiAqL1xuZnVuY3Rpb24gX3Byb2Nlc3NVcGRhdGUoKSB7XG4gIF9uZXh0VXBkYXRlSGFuZGxlID0gMDtcblxuICBjb25zdCBpbnRlcmFjdGlvbkNvdW50ID0gX2ludGVyYWN0aW9uU2V0LnNpemU7XG4gIF9hZGRJbnRlcmFjdGlvblNldC5mb3JFYWNoKGhhbmRsZSA9PiBfaW50ZXJhY3Rpb25TZXQuYWRkKGhhbmRsZSkpO1xuICBfZGVsZXRlSW50ZXJhY3Rpb25TZXQuZm9yRWFjaChoYW5kbGUgPT4gX2ludGVyYWN0aW9uU2V0LmRlbGV0ZShoYW5kbGUpKTtcbiAgY29uc3QgbmV4dEludGVyYWN0aW9uQ291bnQgPSBfaW50ZXJhY3Rpb25TZXQuc2l6ZTtcblxuICBpZiAoaW50ZXJhY3Rpb25Db3VudCAhPT0gMCAmJiBuZXh0SW50ZXJhY3Rpb25Db3VudCA9PT0gMCkge1xuICAgIC8vIHRyYW5zaXRpb24gZnJvbSAxKyAtLT4gMCBpbnRlcmFjdGlvbnNcbiAgICBfZW1pdHRlci5lbWl0KEludGVyYWN0aW9uTWFuYWdlci5FdmVudHMuaW50ZXJhY3Rpb25Db21wbGV0ZSk7XG4gIH0gZWxzZSBpZiAoaW50ZXJhY3Rpb25Db3VudCA9PT0gMCAmJiBuZXh0SW50ZXJhY3Rpb25Db3VudCAhPT0gMCkge1xuICAgIC8vIHRyYW5zaXRpb24gZnJvbSAwIC0tPiAxKyBpbnRlcmFjdGlvbnNcbiAgICBfZW1pdHRlci5lbWl0KEludGVyYWN0aW9uTWFuYWdlci5FdmVudHMuaW50ZXJhY3Rpb25TdGFydCk7XG4gIH1cblxuICAvLyBwcm9jZXNzIHRoZSBxdWV1ZSByZWdhcmRsZXNzIG9mIGEgdHJhbnNpdGlvblxuICBpZiAobmV4dEludGVyYWN0aW9uQ291bnQgPT09IDApIHtcbiAgICB3aGlsZSAoX3Rhc2tRdWV1ZS5oYXNUYXNrc1RvUHJvY2VzcygpKSB7XG4gICAgICBfdGFza1F1ZXVlLnByb2Nlc3NOZXh0KCk7XG4gICAgICBpZiAoXG4gICAgICAgIF9kZWFkbGluZSA+IDAgJiZcbiAgICAgICAgQmF0Y2hlZEJyaWRnZS5nZXRFdmVudExvb3BSdW5uaW5nVGltZSgpID49IF9kZWFkbGluZVxuICAgICAgKSB7XG4gICAgICAgIC8vIEhpdCBkZWFkbGluZSBiZWZvcmUgcHJvY2Vzc2luZyBhbGwgdGFza3MsIHNvIHByb2Nlc3MgbW9yZSBsYXRlci5cbiAgICAgICAgX3NjaGVkdWxlVXBkYXRlKCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICBfYWRkSW50ZXJhY3Rpb25TZXQuY2xlYXIoKTtcbiAgX2RlbGV0ZUludGVyYWN0aW9uU2V0LmNsZWFyKCk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gSW50ZXJhY3Rpb25NYW5hZ2VyO1xuIl0sIm1hcHBpbmdzIjoiQUFVQSxZQUFZOztBQUVaLElB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